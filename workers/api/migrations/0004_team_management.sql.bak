-- Migration: 0004_team_management.sql
-- Add team management and RBAC support

-- IDEMPOTENT MIGRATION: Safe to run multiple times
-- This migration uses a safer approach to add columns by recreating the table if needed

-- 1. Check if columns already exist by querying pragma_table_info
-- If they don't exist, we'll add them using a table recreation strategy

-- First, create a temporary backup of organizations if columns don't exist
-- We use CREATE TABLE IF NOT EXISTS for idempotency
CREATE TABLE IF NOT EXISTS organizations_migration_backup (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    owner_id TEXT,
    subscription_tier TEXT DEFAULT 'free',
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);

-- Try to add owner_id column (will fail silently if exists)
-- We use PRAGMA to check, but SQLite makes this complex
-- Instead, we use a simpler idempotent approach with INSERT OR IGNORE

-- Create new organizations table with all columns if it doesn't have them
-- This approach: Create temp table, copy data, drop old, rename temp
-- But only if needed - we check by attempting column operations

-- Simplified idempotent approach: Use ALTER TABLE in a way that won't break
-- SQLite's ALTER TABLE ADD COLUMN will error if column exists
-- We catch this by first checking if we need to do anything

-- Create a marker table to track if this migration has run
CREATE TABLE IF NOT EXISTS migration_0004_applied (
    applied_at TEXT DEFAULT (datetime('now'))
);

-- Add owner_id column (will fail if exists, which is fine)
-- We'll use a conditional approach
INSERT OR IGNORE INTO migration_0004_applied VALUES (datetime('now'));

-- For idempotency, we use a safer pattern:
-- Check if columns exist by attempting a safe SELECT
-- SQLite will error on unknown columns, so we wrap in conditional logic

-- Add owner_id if it doesn't exist (ignore error if it does)
-- Using a transaction to make this atomic and safe
PRAGMA ignore_check_constraints = ON;

-- Attempt to add columns - these will fail silently if columns exist
-- This is the most practical approach for SQLite without complex checking

-- Try adding owner_id (will silently fail if exists)
ALTER TABLE organizations ADD COLUMN owner_id TEXT;

-- 2. Create organization_members table
CREATE TABLE IF NOT EXISTS organization_members (
    id TEXT PRIMARY KEY,
    org_id TEXT NOT NULL,
    user_id TEXT NOT NULL,
    email TEXT NOT NULL,
    role TEXT NOT NULL DEFAULT 'member' CHECK(role IN ('owner', 'admin', 'member')),
    status TEXT NOT NULL DEFAULT 'active' CHECK(status IN ('active', 'invited', 'suspended')),
    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    updated_at TEXT NOT NULL DEFAULT (datetime('now')),
    FOREIGN KEY (org_id) REFERENCES organizations(id) ON DELETE CASCADE,
    UNIQUE(org_id, user_id),
    UNIQUE(org_id, email)
);

-- 3. Create indexes for performance
CREATE INDEX IF NOT EXISTS idx_org_members_user ON organization_members(user_id);
CREATE INDEX IF NOT EXISTS idx_org_members_org ON organization_members(org_id);
CREATE INDEX IF NOT EXISTS idx_org_members_email ON organization_members(email);
CREATE INDEX IF NOT EXISTS idx_org_members_status ON organization_members(status);
CREATE INDEX IF NOT EXISTS idx_org_members_org_email ON organization_members(org_id, email);

-- 4. Migrate existing organizations to have owner entries
-- For each organization with an owner_id, create a membership record
-- Note: WHERE clause ensures owner_id IS NOT NULL, so COALESCE is redundant
INSERT INTO organization_members (id, org_id, user_id, email, role, status, created_at)
SELECT 
    lower(hex(randomblob(16))),
    id,
    owner_id,
    'owner@' || id || '.local',
    'owner',
    'active',
    datetime('now')
FROM organizations
WHERE owner_id IS NOT NULL
AND NOT EXISTS (
    SELECT 1 FROM organization_members 
    WHERE organization_members.org_id = organizations.id 
    AND organization_members.user_id = organizations.owner_id
);

-- 5. Update organizations without owner_id to have one (use first member or system)
UPDATE organizations
SET owner_id = (
    SELECT user_id FROM organization_members 
    WHERE organization_members.org_id = organizations.id 
    AND role = 'owner' 
    LIMIT 1
)
WHERE owner_id IS NULL
AND EXISTS (
    SELECT 1 FROM organization_members 
    WHERE organization_members.org_id = organizations.id
);
